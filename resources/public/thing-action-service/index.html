<html>

<style>
body {
  font-family: monospace;  
}


div.circle-flash {
  position: absolute;
}

div.round  {
  z-index: -2;
}

span.caption  {
  position: relative;
  z-index: -1;
  left: 30px;
}


div.round {
  -moz-border-radius: 20px/20px;
  -webkit-border-radius: 20px 20px;
  border-radius: 20px/20px;
  border:solid 1px #555;
  /*width:20px;*/
  /*height:20px;*/
  position: absolute;
  padding: 5px;
}


@-webkit-keyframes flash {
    0% {
      opacity:0;
    }
    2% {
      opacity:1;
    }
    100% {
      opacity:0;
    }
}

div.circle-flash {
  -webkit-animation-name: flash;
  -webkit-animation-duration: 10000ms;
  -webkit-animation-iteration-count: 1;
}  

</style>

<body>
</body>


<script>
  function stringHashcode(str) {
    var hash = 0, i, chr, len;
    if (str.length === 0) return hash;
    for (i = 0, len = str.length; i < len; i++) {
      chr   = str.charCodeAt(i);
      hash  = ((hash << 5) - hash) + (chr ^ 2);
      // Truncate to 16 bits
      hash &= 0xFFFFFF;
    }
    return hash;
  }

  var colourRangeLow = 150;
  var colourRangeHigh = 250;
  var colourRange = colourRangeHigh - colourRangeLow;
  function clampColourRange(value) {
    return Math.floor((value / 256) * colourRange + colourRangeLow);
  }

  var context = new AudioContext();
  var oscillator = context.createOscillator();
  var gain = context.createGain();
  oscillator.type="sine";
  oscillator.connect(gain);
  gain.connect(context.destination);
  gain.gain.value = 0;
  oscillator.start(0);
  var beepQueue = [];
  

  function flashCircle(path, count) {
    var circle = document.getElementById(path);

    if (circle != null) {
      console.log("need to remove")
      document.body.removeChild(circle);
    }

    var pathParts = path.split("/");
    // put three components of path in 3d space [0..1].
    var x = stringHashcode(pathParts[0]) / 0xFFFFFF;
    var y = stringHashcode(pathParts[1] + pathParts[2]) / 0xFFFFFF;
    var z = stringHashcode(path);

    
    var red = clampColourRange(z & 0x0000FF);
    var green = clampColourRange((z & 0x00FF00) >> 8);
    var blue = clampColourRange((z & 0xFF0000) >> 16);

    circle = document.createElement("div");
    circle.id = path;
    circle.innerHTML = "<div class='round'>" + count + "</div><span class='caption'>" + pathParts[0] + " &rarr; " + pathParts[1] + " &rarr; " + pathParts[2] + "</span>"
    var round = circle.getElementsByClassName("round")[0];
    circle.style.left = (x * width) + margin;
    circle.style.top = (y * height) + margin;

        console.log(path, circle.style.left, circle.style.top)

    round.style.backgroundColor = "rgb(" + red + ", " + green + ", " + blue + ")";
    circle.className = "circle-flash";

    document.body.appendChild(circle);
  }

  function beep(path, count) {
    var pitch = ((stringHashcode(path) / 0xFFFFFF) * pitchRange) + lowerPitch;
    oscillator.frequency.setValueAtTime(pitch,0);
    gain.gain.value = 1;
    setTimeout(function(){ gain.gain.value = 0; }, 100);
  }

  function serveQueue() {
    var item = beepQueue.shift();
    if (item != undefined) {
      var parts = item.split(";");
      var path = parts[0];
      var count = parseInt(parts[1]);
      beep(path, count);
      flashCircle(path, count);

    }
  }

  setInterval(serveQueue, 200);

  var lowerPitch = 500;
  var upperPitch = 1500;
  var pitchRange = upperPitch - lowerPitch;

  var margin = 100;
  var height = document.body.clientHeight - margin * 2;
  var width = document.body.clientWidth - margin * 2;

  var url = "ws://" + window.location.host + "/socket";
  var socket = new WebSocket(url);


  socket.onopen = function() {
    socket.send("start");
  }

  socket.onmessage = function(item) {
    beepQueue.push(item.data);
  };

  socket.onerror = function() {
    console.log("error");
  }
</script>
</html>
